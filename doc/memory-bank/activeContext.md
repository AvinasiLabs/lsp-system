# Active Context: LSP积分系统

## 当前工作焦点

### 正在进行的任务
1. **项目结构整理** ✅
   - 创建了标准的项目目录结构
   - 整理了现有代码文件
   - 建立了Memory Bank文档体系

2. **数据库环境搭建** ✅
   - PostgreSQL数据库配置完成
   - 成功导入84,552条HealthKit数据
   - 数据库连接池实现

3. **积分计算引擎开发** ✅
   - 实现了基于LSP规则的计算逻辑
   - 支持4个维度的积分计算（睡眠、运动、饮食、心理）
   - 基础的连锁反应检查机制

4. **多用户支持** ✅
   - 数据库表添加user_id字段
   - 所有查询和计算支持用户隔离
   - API接口支持user_id参数

## 最近的更改

### 2025-07-18
1. **项目重组**
   - 将代码移至src/目录下的模块化结构
   - 创建了scripts/目录存放独立脚本
   - 数据文件移至data/目录

2. **文档体系建立**
   - 创建了完整的Memory Bank文档
   - 编写了项目README
   - 添加了.gitignore和requirements.txt

3. **数据导入**
   - 清空了原有表结构
   - 从CSV文件导入了新的HealthKit数据
   - 验证了数据完整性

4. **积分计算系统实现**
   - 创建了健康数据模型和服务层
   - 实现了4个维度的积分计算器
   - 开发了积分计算引擎
   - 创建了REST API接口

5. **多用户支持**
   - 数据库迁移添加user_id字段
   - 创建用户相关表（users, user_scores）
   - 更新所有代码支持用户隔离
   - API接口支持用户参数

6. **FastAPI服务器实现**
   - 创建main.py应用程序入口
   - 配置CORS和中间件
   - 实现健康检查端点
   - 创建启动脚本和测试脚本
   - 编写API使用文档

7. **认证系统配置**
   - 实现可选的认证系统开关
   - JWT令牌生成和验证
   - 认证中间件实现
   - 支持认证和非认证两种模式
   - 完整的测试脚本支持

## 下一步计划

### 立即需要做的
1. **启动FastAPI服务器测试** ✅
   - 创建main.py启动文件
   - 测试所有API端点
   - 验证多用户功能

2. **认证系统配置** ✅
   - 实现认证开关配置
   - JWT令牌管理
   - 支持两种运行模式

3. **完善积分计算逻辑**
   - 实现更多维度的计算器（环境、社交、认知、预防）
   - 添加积分持久化存储到user_scores表
   - 实现连锁反应和惩罚机制
   - 实现超难任务追踪

4. **用户系统完善**
   - 实现真实的用户注册/登录API
   - 密码加密和验证
   - 用户等级自动计算和更新
   - 积分历史记录查询API

### 短期目标（1-2周）
1. **完成核心计算引擎**
   - 所有8个维度的计算器
   - 规则引擎实现
   - 等级系统实现

2. **API开发**
   - FastAPI项目搭建
   - 用户认证系统
   - 积分查询和计算API

3. **测试体系**
   - 单元测试框架搭建
   - 核心功能测试用例
   - 集成测试

## 当前决策和考虑

### 技术决策
1. **使用FastAPI而非Flask**
   - 原因：自动API文档、异步支持、类型验证
   - 影响：需要学习FastAPI的模式

2. **积分计算采用插件化架构**
   - 原因：便于扩展新的维度和规则
   - 实现：抽象基类 + 具体实现类

3. **配置驱动的规则系统**
   - 原因：规则可能经常调整
   - 方案：YAML配置文件 + 规则解析器

### 需要解决的问题
1. **数据一致性**
   - 如何处理重复数据导入
   - 积分计算的幂等性保证
   - 并发计算的冲突处理

2. **性能优化**
   - 大量历史数据的批量计算
   - 实时积分更新的响应速度
   - 排行榜等聚合查询的优化

3. **业务逻辑**
   - 积分过期机制的实现
   - 连锁反应的追踪和计算
   - 作弊检测算法

## 关键文件位置

### 核心代码
- 数据库连接：`src/db/postgresql.py`
- 配置管理：`src/db/configs/`
- 工具函数：`src/utils/`

### 脚本工具
- 数据库测试：`scripts/test_db_connection.py`
- CSV导入：`scripts/import_csv_to_db.py`
- 数据分析：`scripts/analyze_healthkit_data.py`

### 文档资源
- 积分规则：`doc/LSP积分系统规则`
- 数据需求：`doc/LSP积分系统数据需求整理.md`
- Memory Bank：`doc/memory-bank/`

## 待确认事项

1. **用户系统设计**
   - 是否需要支持多租户？
   - 用户认证方式（JWT/Session）？
   - 社交登录集成？

2. **数据隐私**
   - 健康数据的加密存储方案
   - 数据访问权限控制
   - GDPR合规要求

3. **商业模式**
   - 积分的实际价值体现
   - 付费功能的边界
   - 企业版本的差异化
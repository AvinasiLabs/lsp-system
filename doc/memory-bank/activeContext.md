# Active Context: LSP积分系统

## 当前工作焦点

### 正在进行的任务
1. **项目结构整理** ✅
   - 创建了标准的项目目录结构
   - 整理了现有代码文件
   - 建立了Memory Bank文档体系

2. **数据库环境搭建** ✅
   - PostgreSQL数据库配置完成
   - 成功导入84,552条HealthKit数据
   - 数据库连接池实现

3. **积分计算引擎开发** 🔄
   - 需要实现基于LSP规则的计算逻辑
   - 支持8个维度的积分计算
   - 处理连锁反应和惩罚机制

## 最近的更改

### 2025-07-18
1. **项目重组**
   - 将代码移至src/目录下的模块化结构
   - 创建了scripts/目录存放独立脚本
   - 数据文件移至data/目录

2. **文档体系建立**
   - 创建了完整的Memory Bank文档
   - 编写了项目README
   - 添加了.gitignore和requirements.txt

3. **数据导入**
   - 清空了原有表结构
   - 从CSV文件导入了新的HealthKit数据
   - 验证了数据完整性

## 下一步计划

### 立即需要做的
1. **修复导入路径问题**
   - 更新scripts/目录下脚本的导入路径
   - 确保所有模块可以正确导入

2. **实现积分计算核心**
   - 创建维度计算器基类
   - 实现睡眠维度计算器（作为第一个示例）
   - 建立规则配置系统

3. **数据模型定义**
   - 使用SQLAlchemy定义ORM模型
   - 创建用户表和积分记录表
   - 设计等级系统表结构

### 短期目标（1-2周）
1. **完成核心计算引擎**
   - 所有8个维度的计算器
   - 规则引擎实现
   - 等级系统实现

2. **API开发**
   - FastAPI项目搭建
   - 用户认证系统
   - 积分查询和计算API

3. **测试体系**
   - 单元测试框架搭建
   - 核心功能测试用例
   - 集成测试

## 当前决策和考虑

### 技术决策
1. **使用FastAPI而非Flask**
   - 原因：自动API文档、异步支持、类型验证
   - 影响：需要学习FastAPI的模式

2. **积分计算采用插件化架构**
   - 原因：便于扩展新的维度和规则
   - 实现：抽象基类 + 具体实现类

3. **配置驱动的规则系统**
   - 原因：规则可能经常调整
   - 方案：YAML配置文件 + 规则解析器

### 需要解决的问题
1. **数据一致性**
   - 如何处理重复数据导入
   - 积分计算的幂等性保证
   - 并发计算的冲突处理

2. **性能优化**
   - 大量历史数据的批量计算
   - 实时积分更新的响应速度
   - 排行榜等聚合查询的优化

3. **业务逻辑**
   - 积分过期机制的实现
   - 连锁反应的追踪和计算
   - 作弊检测算法

## 关键文件位置

### 核心代码
- 数据库连接：`src/db/postgresql.py`
- 配置管理：`src/db/configs/`
- 工具函数：`src/utils/`

### 脚本工具
- 数据库测试：`scripts/test_db_connection.py`
- CSV导入：`scripts/import_csv_to_db.py`
- 数据分析：`scripts/analyze_healthkit_data.py`

### 文档资源
- 积分规则：`doc/LSP积分系统规则`
- 数据需求：`doc/LSP积分系统数据需求整理.md`
- Memory Bank：`doc/memory-bank/`

## 待确认事项

1. **用户系统设计**
   - 是否需要支持多租户？
   - 用户认证方式（JWT/Session）？
   - 社交登录集成？

2. **数据隐私**
   - 健康数据的加密存储方案
   - 数据访问权限控制
   - GDPR合规要求

3. **商业模式**
   - 积分的实际价值体现
   - 付费功能的边界
   - 企业版本的差异化